<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Essay Coach - College Climb</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* ============================================
           UNIVERSAL NAVBAR STYLES (from dashboard.html)
           ============================================ */
        :root {
            --primary-bg: #ffffff;
            --secondary-bg: #f8f9ff;
            --accent-bg: #2a357a;
            --text-primary: #333333;
            --text-secondary: #666666;
            --accent-color: #a07bcc;
            --gradient: linear-gradient(135deg, #2a357a 0%, #a07bcc 100%);
            --shadow: 0 8px 32px rgba(42, 53, 122, 0.12);
            --border-radius: 16px;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --info-color: #3b82f6;
        }

        [data-theme="dark"] {
            --primary-bg: #0d1117;
            --secondary-bg: #161b22;
            --accent-bg: #21262d;
            --text-primary: #f0f6fc;
            --text-secondary: #8b949e;
            --accent-color: #bb86fc;
            --gradient: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            line-height: 1.6;
            color: var(--text-primary);
            background: var(--primary-bg);
            transition: all 0.3s ease;
            overflow-x: hidden;
        }

        /* Navigation Bar */
        .cc-navbar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
            transition: all 0.3s ease;
            border-bottom: 1px solid rgba(160, 123, 204, 0.1);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        [data-theme="dark"] .cc-navbar {
            background: rgba(13, 17, 23, 0.95);
            border-bottom-color: rgba(187, 134, 252, 0.1);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .cc-logo-section {
            display: flex;
            align-items: center;
            gap: 1rem;
            cursor: pointer;
            text-decoration: none;
        }

        .cc-logo {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            overflow: hidden;
            transition: transform 0.3s ease;
        }

        .cc-logo:hover {
            transform: scale(1.1) rotate(5deg);
        }

        .cc-logo img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .cc-brand-text {
            display: flex;
            flex-direction: column;
            gap: 0;
            line-height: 1;
        }

        .cc-brand-text h1 {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1;
            margin: 0;
        }

        .cc-brand-text h2 {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1;
            margin: 0;
        }

        .cc-nav-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        /* Theme Toggle Button */
        .cc-theme-toggle {
            background: var(--gradient);
            border: none;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            transition: all 0.3s ease;
            font-size: 1.2rem;
        }

        .cc-theme-toggle:hover {
            transform: scale(1.1) rotate(180deg);
            box-shadow: var(--shadow);
        }

        /* Profile Dropdown Container */
        .cc-profile-dropdown {
            position: relative;
        }

        /* Profile Button */
        .cc-profile-button {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            padding: 0.3rem;
            border-radius: 50%;
            transition: all 0.3s ease;
            background: transparent;
            border: none;
            position: relative;
        }

        .cc-profile-button:hover .cc-user-avatar {
            transform: scale(1.08);
            box-shadow: 0 0 0 3px rgba(160, 123, 204, 0.2);
        }

        .cc-profile-button:active .cc-user-avatar {
            transform: scale(0.95);
        }

        /* User Avatar */
        .cc-user-avatar {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--accent-color);
            transition: all 0.3s ease;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(160, 123, 204, 0.2);
        }

        [data-theme="dark"] .cc-user-avatar {
            border-color: var(--accent-color);
            box-shadow: 0 2px 12px rgba(187, 134, 252, 0.3);
        }

        /* Profile Text - Hidden completely */
        .cc-profile-text {
            display: none !important;
        }

        /* Dropdown Chevron - Hidden */
        .cc-dropdown-chevron {
            display: none !important;
        }

        /* Dropdown Menu */
        .cc-dropdown-menu {
            position: absolute;
            top: calc(100% + 0.75rem);
            right: 0;
            background: var(--primary-bg);
            box-shadow: 0 10px 40px rgba(42, 53, 122, 0.15), 0 0 0 1px rgba(160, 123, 204, 0.1);
            border-radius: 20px;
            padding: 0.75rem;
            min-width: 280px;
            max-width: 320px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-15px) scale(0.9);
            transform-origin: top right;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(160, 123, 204, 0.15);
            backdrop-filter: blur(20px);
        }

        [data-theme="dark"] .cc-dropdown-menu {
            background: rgba(22, 27, 34, 0.98);
            border-color: rgba(187, 134, 252, 0.2);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(187, 134, 252, 0.15);
        }

        .cc-dropdown-menu.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0) scale(1);
        }

        /* Add arrow pointer to dropdown */
        .cc-dropdown-menu::before {
            content: '';
            position: absolute;
            top: -6px;
            right: 16px;
            width: 12px;
            height: 12px;
            background: var(--primary-bg);
            border: 1px solid rgba(160, 123, 204, 0.15);
            border-bottom: none;
            border-right: none;
            transform: rotate(45deg);
        }

        [data-theme="dark"] .cc-dropdown-menu::before {
            background: rgba(22, 27, 34, 0.98);
            border-color: rgba(187, 134, 252, 0.2);
        }

        /* Welcome Header in Dropdown */
        .cc-dropdown-header {
            padding: 1.25rem;
            border-bottom: 2px solid rgba(160, 123, 204, 0.1);
            margin-bottom: 0.75rem;
            background: var(--secondary-bg);
            border-radius: 14px;
            text-align: center;
        }

        [data-theme="dark"] .cc-dropdown-header {
            border-bottom-color: rgba(187, 134, 252, 0.15);
            background: rgba(33, 38, 45, 0.6);
        }

        .cc-dropdown-welcome {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .cc-dropdown-name {
            font-size: 1.25rem;
            font-weight: 800;
            background: var(--gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.3rem;
        }

        .cc-dropdown-email {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 0.3rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            padding: 0 0.5rem;
        }

        /* Dropdown Links */
        .cc-dropdown-link {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.9rem 1.1rem;
            color: var(--text-primary);
            text-decoration: none;
            transition: all 0.25s ease;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.95rem;
            margin-bottom: 0.3rem;
            position: relative;
            overflow: hidden;
        }

        .cc-dropdown-link::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 0;
            background: var(--gradient);
            opacity: 0.1;
            transition: width 0.3s ease;
        }

        .cc-dropdown-link:hover {
            background: var(--secondary-bg);
            transform: translateX(4px);
            color: var(--accent-color);
        }

        .cc-dropdown-link:hover::before {
            width: 4px;
        }

        [data-theme="dark"] .cc-dropdown-link:hover {
            background: rgba(33, 38, 45, 0.8);
        }

        .cc-dropdown-link:active {
            transform: translateX(2px) scale(0.98);
        }

        .cc-dropdown-link-icon {
            font-size: 1.3rem;
            width: 28px;
            text-align: center;
            transition: transform 0.3s ease;
        }

        .cc-dropdown-link:hover .cc-dropdown-link-icon {
            transform: scale(1.15);
        }

        /* Logout Button */
        .cc-dropdown-divider {
            height: 2px;
            background: linear-gradient(90deg, transparent, rgba(160, 123, 204, 0.2), transparent);
            margin: 0.5rem 0;
        }

        [data-theme="dark"] .cc-dropdown-divider {
            background: linear-gradient(90deg, transparent, rgba(187, 134, 252, 0.2), transparent);
        }

        .cc-logout-link {
            color: var(--danger-color) !important;
            font-weight: 700 !important;
        }

        .cc-logout-link:hover {
            background: rgba(239, 68, 68, 0.1) !important;
        }

        .cc-logout-link:hover::before {
            background: var(--danger-color) !important;
        }

        /* Loading State */
        .cc-profile-loading {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: 3px solid var(--secondary-bg);
            border-top-color: var(--accent-color);
            animation: cc-spin 0.8s linear infinite;
        }

        @keyframes cc-spin {
            to { transform: rotate(360deg); }
        }

        /* Active state indicator */
        .cc-profile-dropdown.open .cc-user-avatar {
            box-shadow: 0 0 0 3px rgba(160, 123, 204, 0.3);
        }

        [data-theme="dark"] .cc-profile-dropdown.open .cc-user-avatar {
            box-shadow: 0 0 0 3px rgba(187, 134, 252, 0.4);
        }

        /* ============================================
           ESSAY COACH SPECIFIC STYLES
           ============================================ */

        .starry-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        [data-theme="dark"] .starry-bg {
            opacity: 1;
        }

        .star {
            position: absolute;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            animation: twinkle 3s infinite ease-in-out;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.3; transform: scale(0.8); }
            50% { opacity: 1; transform: scale(1.2); }
        }

        /* Main Essay Coach Container */
        .essay-coach-container {
            margin-top: 100px;
            padding: 2rem;
            max-width: 1600px;
            margin-left: auto;
            margin-right: auto;
            min-height: calc(100vh - 200px);
        }

        /* Header Section */
        .essay-header {
            background: var(--gradient);
            border-radius: 24px;
            padding: 3rem 2rem;
            text-align: center;
            margin-bottom: 3rem;
            box-shadow: var(--shadow);
            color: white;
            position: relative;
            overflow: hidden;
        }

        .essay-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 80%, rgba(255, 255, 255, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 255, 255, 0.1) 0%, transparent 50%);
            pointer-events: none;
        }

        .essay-header h1 {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 1rem;
            position: relative;
            z-index: 2;
        }

        .essay-header p {
            font-size: 1.2rem;
            opacity: 0.95;
            position: relative;
            z-index: 2;
            max-width: 600px;
            margin: 0 auto;
        }

        /* Main Grid Layout */
        .essay-main-grid {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 2rem;
            margin-bottom: 3rem;
        }

        /* Essay Editor Section */
        .essay-editor-section {
            background: var(--primary-bg);
            border-radius: 24px;
            padding: 2rem;
            box-shadow: var(--shadow);
            border: 1px solid rgba(160, 123, 204, 0.1);
        }

        .essay-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid var(--secondary-bg);
        }

        .essay-tab {
            padding: 1rem 2rem;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-weight: 600;
            cursor: pointer;
            border-radius: 12px 12px 0 0;
            transition: all 0.3s ease;
            position: relative;
        }

        .essay-tab.active {
            color: var(--accent-color);
            background: var(--secondary-bg);
        }

        .essay-tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--accent-color);
        }

        .essay-content {
            display: none;
        }

        .essay-content.active {
            display: block;
        }

        /* Essay Prompts */
        .prompt-selector {
            margin-bottom: 2rem;
        }

        .prompt-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .prompt-card {
            background: var(--secondary-bg);
            border: 2px solid transparent;
            border-radius: 16px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .prompt-card:hover {
            border-color: var(--accent-color);
            transform: translateY(-2px);
        }

        .prompt-card.selected {
            border-color: var(--accent-color);
            background: rgba(160, 123, 204, 0.1);
        }

        .prompt-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .prompt-preview {
            font-size: 0.9rem;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        /* Essay Editor */
        .essay-editor {
            position: relative;
        }

        .editor-toolbar {
            display: flex;
            gap: 1rem;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
            padding: 1rem;
            background: var(--secondary-bg);
            border-radius: 12px;
            border: 1px solid rgba(160, 123, 204, 0.1);
        }

        .editor-controls {
            display: flex;
            gap: 0.5rem;
        }

        .editor-btn {
            padding: 0.5rem 1rem;
            background: var(--primary-bg);
            border: 1px solid rgba(160, 123, 204, 0.2);
            border-radius: 8px;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .editor-btn:hover {
            background: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }

        .word-count {
            font-size: 0.9rem;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .essay-textarea {
            width: 100%;
            min-height: 400px;
            padding: 2rem;
            border: 2px solid rgba(160, 123, 204, 0.1);
            border-radius: 16px;
            background: var(--primary-bg);
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            line-height: 1.8;
            resize: vertical;
            outline: none;
            transition: all 0.3s ease;
        }

        .essay-textarea:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(160, 123, 204, 0.1);
        }

        .essay-textarea::placeholder {
            color: var(--text-secondary);
            opacity: 0.7;
        }

        /* Contenteditable essay editor with highlighting */
        .essay-editing-container {
            position: relative;
            width: 100%;
        }

        .essay-textarea-editable {
            width: 100%;
            min-height: 400px;
            padding: 2rem;
            border: 2px solid rgba(160, 123, 204, 0.1);
            border-radius: 16px;
            background: var(--primary-bg);
            color: var(--text-primary);  /* This ensures text color changes with theme */
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            line-height: 1.8;
            outline: none;
            transition: all 0.3s ease;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .essay-textarea-editable:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(160, 123, 204, 0.1);
            color: var(--text-primary);  /* Ensure color stays correct when focused */
        }

        .essay-textarea-editable:empty:before {
            content: attr(data-placeholder);
            color: var(--text-secondary);
            opacity: 0.7;
        }

        .essay-textarea-editable * {
            color: inherit;
        }

        /* Text highlighting styles */
        .highlight-red {
            background-color: rgba(239, 68, 68, 0.3);
            border-bottom: 2px solid #ef4444;
            padding: 2px 0;
            cursor: help;
            position: relative;
        }

        .highlight-yellow {
            background-color: rgba(245, 158, 11, 0.3);
            border-bottom: 2px solid #f59e0b;
            padding: 2px 0;
            cursor: help;
            position: relative;
        }

        .highlight-green {
            background-color: rgba(16, 185, 129, 0.3);
            border-bottom: 2px solid #10b981;
            padding: 2px 0;
            cursor: help;
            position: relative;
        }

        [data-theme="dark"] .highlight-red {
            background-color: rgba(239, 68, 68, 0.2);
        }

        [data-theme="dark"] .highlight-yellow {
            background-color: rgba(245, 158, 11, 0.2);
        }

        [data-theme="dark"] .highlight-green {
            background-color: rgba(16, 185, 129, 0.2);
        }

        /* Highlight legend samples */
        .highlight-sample {
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 2px solid;
        }

        .highlight-sample.highlight-red {
            background-color: rgba(239, 68, 68, 0.3);
            border-color: #ef4444;
        }

        .highlight-sample.highlight-yellow {
            background-color: rgba(245, 158, 11, 0.3);
            border-color: #f59e0b;
        }

        .highlight-sample.highlight-green {
            background-color: rgba(16, 185, 129, 0.3);
            border-color: #10b981;
        }

        .highlight-legend {
            background: var(--secondary-bg);
            padding: 1rem;
            border-radius: 12px;
            border: 1px solid rgba(160, 123, 204, 0.1);
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .modal-content {
            background: var(--primary-bg);
            border-radius: 24px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow);
            animation: modalSlideIn 0.3s ease;
        }

        .modal-large {
            max-width: 800px;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 2rem;
            border-bottom: 2px solid var(--secondary-bg);
        }

        .modal-header h2 {
            color: var(--text-primary);
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 2rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: color 0.3s ease;
            line-height: 1;
        }

        .modal-close:hover {
            color: var(--danger-color);
        }

        .modal-body {
            padding: 2rem;
        }

        .modal-footer {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            padding: 1.5rem 2rem;
            border-top: 2px solid var(--secondary-bg);
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: var(--gradient);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .btn-secondary {
            background: var(--secondary-bg);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background: rgba(160, 123, 204, 0.1);
        }

        /* College Selection List */
        .college-selection-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .college-selection-list label {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem;
            background: var(--secondary-bg);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .college-selection-list label:hover {
            background: rgba(160, 123, 204, 0.1);
            transform: translateX(5px);
        }

        .college-selection-list input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        /* Chat Interface Styles */
        .chat-messages {
            min-height: 400px;
            max-height: 500px;
            overflow-y: auto;
            padding: 1rem;
            background: var(--secondary-bg);
            border-radius: 16px;
            margin-bottom: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .chat-message {
            display: flex;
            gap: 1rem;
            animation: messageSlideIn 0.3s ease;
        }

        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .chat-message.user {
            flex-direction: row-reverse;
        }

        .chat-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            flex-shrink: 0;
        }

        .chat-bubble {
            background: var(--primary-bg);
            padding: 1rem;
            border-radius: 16px;
            max-width: 70%;
            color: var(--text-primary);
            line-height: 1.6;
        }

        .chat-message.user .chat-bubble {
            background: var(--gradient);
            color: white;
        }

        .chat-input-container {
            display: flex;
            gap: 0.75rem;
        }

        .chat-input-container input {
            flex: 1;
            padding: 1rem;
            border: 2px solid rgba(160, 123, 204, 0.2);
            border-radius: 12px;
            background: var(--secondary-bg);
            color: var(--text-primary);
            font-size: 1rem;
            outline: none;
            transition: all 0.3s ease;
        }

        .chat-input-container input:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(160, 123, 204, 0.1);
        }

        .chat-input-container button {
            padding: 1rem 1.5rem;
        }

        /* AI Feedback Section */
        .ai-feedback-section {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        .feedback-panel {
            background: var(--primary-bg);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: var(--shadow);
            border: 1px solid rgba(160, 123, 204, 0.1);
        }

        .panel-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: var (--text-primary);
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .ai-analysis-btn {
            width: 100%;
            padding: 1rem 2rem;
            background: var(--gradient);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-bottom: 2rem;
        }

        .ai-analysis-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .ai-analysis-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .feedback-content {
            display: none;
        }

        .feedback-content.show {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .feedback-score {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: var(--secondary-bg);
            border-radius: 12px;
            border: 1px solid rgba(160, 123, 204, 0.1);
        }

        .score-circle {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: 800;
            color: white;
            position: relative;
        }

        .score-excellent { background: var(--success-color); }
        .score-good { background: var(--info-color); }
        .score-fair { background: var(--warning-color); }
        .score-needs-work { background: var(--danger-color); }

        .score-details h3 {
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .score-details p {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .feedback-categories {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
        }

        .feedback-category {
            background: var(--secondary-bg);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid rgba(160, 123, 204, 0.1);
        }

        .category-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .category-title {
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .category-score {
            font-size: 0.9rem;
            font-weight: 600;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            color: white;
        }

        .category-feedback {
            color: var(--text-secondary);
            line-height: 1.6;
        }

        /* Essay Library */
        .essay-library {
            background: var(--primary-bg);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: var(--shadow);
            border: 1px solid rgba(160, 123, 204, 0.1);
        }

        .essay-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .essay-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            background: var(--secondary-bg);
            border-radius: 12px;
            border: 1px solid rgba(160, 123, 204, 0.1);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .essay-item:hover {
            border-color: var(--accent-color);
            transform: translateX(5px);
        }

        .essay-info h4 {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .essay-meta {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .essay-actions {
            display: flex;
            gap: 0.5rem;
        }

        .essay-action-btn {
            padding: 0.5rem;
            background: none;
            border: 1px solid rgba(160, 123, 204, 0.2);
            border-radius: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .essay-action-btn:hover {
            color: var(--accent-color);
            border-color: var(--accent-color);
        }

        /* Personalized Tips */
        .tips-section {
            background: var(--primary-bg);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: var(--shadow);
            border: 1px solid rgba(160, 123, 204, 0.1);
        }

        .tip-card {
            background: var(--secondary-bg);
            border-radius: 12px;
            padding: 1.5rem;
            border-left: 4px solid var(--accent-color);
            margin-bottom: 1rem;
        }

        .tip-card:last-child {
            margin-bottom: 0;
        }

        .tip-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .tip-content {
            color: var(--text-secondary);
            line-height: 1.6;
        }

        /* Loading States */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(160, 123, 204, 0.3);
            border-top-color: var(--accent-color);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Essay Progress Styles */
        .essay-progress {
            background: var(--secondary-bg);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 1px solid rgba(160, 123, 204, 0.1);
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(160, 123, 204, 0.1);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: var(--gradient);
            border-radius: 10px;
            transition: width 0.3s ease;
            box-shadow: 0 0 10px rgba(160, 123, 204, 0.5);
        }

        /* Footer Styles */
        .footer {
            background: var(--secondary-bg);
            border-top: 1px solid rgba(160, 123, 204, 0.1);
            padding: 2rem 0;
            margin-top: 4rem;
        }

        [data-theme="dark"] .footer {
            background: var(--accent-bg);
            border-top-color: rgba(187, 134, 252, 0.1);
        }

        .footer-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 2rem;
        }

        .footer-logo {
            display: flex;
            align-items: center;
        }

        .footer-logo img {
            width: 50px;
            height: 50px;
            border-radius: 12px;
        }

        .footer-text {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .footer-socials {
            display: flex;
            gap: 1rem;
        }

        .footer-socials a {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(160, 123, 204, 0.1);
            transition: all 0.3s ease;
        }

        .footer-socials a:hover {
            background: var(--accent-color);
            transform: translateY(-3px);
        }

        .footer-socials img {
            width: 18px;
            height: 18px;
            filter: invert(1);
        }

        [data-theme="dark"] .footer-socials img {
            filter: invert(0.8);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .cc-navbar {
                padding: 1rem;
            }

            .cc-logo {
                width: 40px;
                height: 40px;
            }

            .cc-brand-text h1,
            .cc-brand-text h2 {
                font-size: 1.1rem;
            }

            .essay-main-grid {
                grid-template-columns: 1fr;
            }

            .essay-header h1 {
                font-size: 1.8rem;
            }

            .essay-header p {
                font-size: 1rem;
            }

            .footer-content {
                flex-direction: column;
                text-align: center;
            }

            .prompt-grid {
                grid-template-columns: 1fr;
            }

            .editor-toolbar {
                flex-direction: column;
                gap: 1rem;
            }

            .essay-coach-container {
                padding: 1rem;
            }
        }
    </style>
</head>
<body data-theme="dark">
    <div class="starry-bg" id="starryBg"></div>

    <!-- ============================================
         UNIVERSAL NAVBAR
         ============================================ -->
    <nav class="cc-navbar">
        <!-- Logo Section -->
        <a href="index.html" class="cc-logo-section">
            <div class="cc-logo">
                <img id="ccNavbarLogo" src="images/whiteclearcc.png" alt="College Climb Logo">
            </div>
            <div class="cc-brand-text">
                <h1>College</h1>
                <h2>Climb</h2>
            </div>
        </a>

        <!-- Right Side Navigation -->
        <div class="cc-nav-right">
            <!-- Theme Toggle -->
            <button class="cc-theme-toggle" id="ccThemeToggle" aria-label="Toggle theme">
                ☀️
            </button>

            <!-- Profile Dropdown -->
            <div class="cc-profile-dropdown" id="ccProfileDropdown">
                <div class="cc-profile-button" id="ccProfileButton">
                    <!-- Loading state initially -->
                    <div class="cc-profile-loading" id="ccProfileLoading"></div>
                    
                    <!-- Profile content (hidden initially) -->
                    <div id="ccProfileContent" style="display: none;">
                        <img id="ccUserAvatar" class="cc-user-avatar" src="images/default-avatar.png" alt="Profile">
                    </div>
                </div>

                <!-- Dropdown Menu -->
                <div class="cc-dropdown-menu" id="ccDropdownMenu">
                    <!-- Welcome Header -->
                    <div class="cc-dropdown-header" id="ccDropdownHeader">
                        <div class="cc-dropdown-welcome">Hello,</div>
                        <div class="cc-dropdown-name" id="ccDropdownName">Guest</div>
                        <div class="cc-dropdown-email" id="ccDropdownEmail"></div>
                    </div>

                    <!-- Navigation Links -->
                    <a href="dashboard.html" class="cc-dropdown-link">
                        <span class="cc-dropdown-link-icon">📊</span>
                        <span>Dashboard</span>
                    </a>

                    <a href="testprep.html" class="cc-dropdown-link">
                        <span class="cc-dropdown-link-icon">📚</span>
                        <span>Test Prep</span>
                    </a>

                    <a href="essaycoach.html" class="cc-dropdown-link">
                        <span class="cc-dropdown-link-icon">✍️</span>
                        <span>Essays</span>
                    </a>
                    
                    <a href="scholarship.html" class="cc-dropdown-link">
                        <span class="cc-dropdown-link-icon">💰</span>
                        <span>Scholarships</span>
                    </a>
                    
                    <a href="document.html" class="cc-dropdown-link">
                        <span class="cc-dropdown-link-icon">📄</span>
                        <span>Documents</span>
                    </a>
                    
                    <a href="profile.html" class="cc-dropdown-link">
                        <span class="cc-dropdown-link-icon">👤</span>
                        <span>Profile</span>
                    </a>

                    <!-- Divider -->
                    <div class="cc-dropdown-divider"></div>

                    <!-- Logout -->
                    <a href="#" class="cc-dropdown-link cc-logout-link" id="ccLogoutBtn">
                        <span class="cc-dropdown-link-icon">🚪</span>
                        <span>Logout</span>
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Essay Coach Container -->
    <div class="essay-coach-container">
        <!-- Header -->
        <div class="essay-header">
            <h1><i class="fas fa-pen-fancy"></i> AI Essay Coach</h1>
            <p id="headerMessage">Get personalized feedback and guidance to craft compelling college essays that showcase your unique story</p>
        </div>

        <!-- Main Grid -->
        <div class="essay-main-grid">
            <!-- Essay Editor Section -->
            <div class="essay-editor-section">
                <!-- Essay Progress -->
                <div class="essay-progress">
                    <div class="progress-header">
                        <span><strong id="essayProgressTitle">Personal Statement Progress</strong></span>
                        <span id="essayProgressPercent">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                    </div>
                </div>

                <!-- Essay Tabs -->
                <div class="essay-tabs">
                    <button class="essay-tab active" onclick="switchTab('personal-statement')">
                        <i class="fas fa-user"></i> Personal Statement
                    </button>
                    <button class="essay-tab" onclick="switchTab('supplemental')">
                        <i class="fas fa-plus"></i> Supplemental Essays
                    </button>
                    <button class="essay-tab" onclick="switchTab('library')">
                        <i class="fas fa-book"></i> My Essays
                    </button>
                </div>

                <!-- Personal Statement Tab -->
                <div class="essay-content active" id="personal-statement-content">
                    <!-- Prompt Selector -->
                    <div class="prompt-selector">
                        <h3 style="margin-bottom: 1rem; color: var(--text-primary);">
                            <i class="fas fa-lightbulb"></i> Choose Your Prompt
                        </h3>
                        <div class="prompt-grid" id="personalPromptGrid">
                            <!-- Prompts will be populated by JavaScript -->
                        </div>
                    </div>

                    <!-- Essay Editor -->
                    <div class="essay-editor">
                        <div class="editor-toolbar">
                            <div class="editor-controls">
                                <button class="editor-btn" onclick="saveEssay()">
                                    <i class="fas fa-save"></i> Save Draft
                                </button>
                                <button class="editor-btn" onclick="exportEssay()">
                                    <i class="fas fa-download"></i> Export
                                </button>
                                <button class="editor-btn" onclick="clearEssay()">
                                    <i class="fas fa-trash"></i> Clear
                                </button>
                            </div>
                            <div class="word-count">
                                <span id="wordCount">0</span> words | <span id="charCount">0</span> characters
                            </div>
                        </div>

                        <!-- Essay editing area with highlighting support -->
                        <div class="essay-editing-container">
                            <div
                                class="essay-textarea-editable"
                                id="essayText"
                                contenteditable="true"
                                data-placeholder="Start writing your personal statement here. Remember to be authentic, specific, and showcase what makes you unique..."
                                oninput="updateWordCount(); saveProgress(); clearHighlights();">
                            </div>
                        </div>

                        <!-- Highlighting Legend -->
                        <div class="highlight-legend" id="highlightLegend" style="display: none; margin-top: 1rem;">
                            <div style="font-weight: 600; margin-bottom: 0.5rem; color: var(--text-primary);">
                                <i class="fas fa-info-circle"></i> AI Feedback Legend:
                            </div>
                            <div style="display: flex; gap: 1.5rem; flex-wrap: wrap;">
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span class="highlight-sample highlight-red"></span>
                                    <span style="color: var(--text-secondary); font-size: 0.9rem;">Needs Change</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span class="highlight-sample highlight-yellow"></span>
                                    <span style="color: var(--text-secondary); font-size: 0.9rem;">Could Be Better</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span class="highlight-sample highlight-green"></span>
                                    <span style="color: var(--text-secondary); font-size: 0.9rem;">Great! Keep This</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Supplemental Essays Tab -->
                <div class="essay-content" id="supplemental-content">
                    <div class="prompt-selector">
                        <h3 style="margin-bottom: 1rem; color: var(--text-primary);">
                            <i class="fas fa-university"></i> School-Specific Essays
                        </h3>
                        <div id="supplementalPrompts">
                            <!-- School-specific prompts will be populated based on user's target schools -->
                        </div>
                    </div>
                </div>

                <!-- Essay Library Tab -->
                <div class="essay-content" id="library-content">
                    <div class="essay-library">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                            <h3 style="color: var(--text-primary);">
                                <i class="fas fa-folder-open"></i> My Essays
                            </h3>
                            <button class="editor-btn" onclick="createNewEssay()">
                                <i class="fas fa-plus"></i> New Essay
                            </button>
                        </div>
                        <div class="essay-list" id="essayList">
                            <!-- User's saved essays will be populated here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- AI Feedback Sidebar -->
            <div class="ai-feedback-section">
                <!-- AI Analysis Panel -->
                <div class="feedback-panel">
                    <div class="panel-title">
                        <i class="fas fa-robot"></i> AI Analysis
                    </div>
                    
                    <button class="ai-analysis-btn" id="analyzeBtn" onclick="analyzeEssay()">
                        <i class="fas fa-magic"></i>
                        <span id="analyzeBtnText">Analyze My Essay</span>
                    </button>

                    <button class="ai-analysis-btn" id="askAIBtn" onclick="openChatModal()" style="background: linear-gradient(135deg, #16213e 0%, #0f3460 100%);">
                        <i class="fas fa-comments"></i>
                        Ask AI Questions
                    </button>

                    <div class="feedback-content" id="feedbackContent">
                        <!-- Overall Score -->
                        <div class="feedback-score" id="overallScore">
                            <div class="score-circle score-excellent" id="scoreCircle">
                                <span id="scoreNumber">85</span>
                            </div>
                            <div class="score-details">
                                <h3 id="scoreTitle">Excellent Essay!</h3>
                                <p id="scoreDescription">Your essay demonstrates strong personal voice and compelling storytelling.</p>
                            </div>
                        </div>

                        <!-- Feedback Categories -->
                        <div class="feedback-categories" id="feedbackCategories">
                            <!-- Categories will be populated by AI analysis -->
                        </div>
                    </div>
                </div>

                <!-- Personalized Tips Panel -->
                <div class="tips-section">
                    <div class="panel-title">
                        <i class="fas fa-lightbulb"></i> Personalized Tips
                    </div>
                    <div id="personalizedTips">
                        <!-- Tips will be generated based on user profile -->
                    </div>
                </div>

                <!-- Essay Library Panel -->
                <div class="feedback-panel">
                    <div class="panel-title">
                        <i class="fas fa-chart-line"></i> Progress Tracker
                    </div>
                    <div id="progressTracker">
                        <div style="text-align: center; margin-bottom: 1rem;">
                            <div style="font-size: 2rem; font-weight: 800; color: var(--accent-color);" id="totalEssaysCount">0</div>
                            <div style="color: var(--text-secondary);">Essays Completed</div>
                        </div>
                        <div id="schoolProgress">
                            <!-- Progress for each target school -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- College Selection Modal -->
    <div id="collegeSelectionModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-university"></i> Select Target College(s)</h2>
                <button class="modal-close" onclick="closeCollegeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
                    Which college(s) is this essay for? This helps me tailor specific advice for those schools.
                </p>
                <div id="collegeCheckboxes" class="college-selection-list">
                    <!-- Will be populated with user's target schools -->
                </div>
                <div style="margin-top: 1rem;">
                    <label style="display: flex; align-items: center; gap: 0.5rem; color: var(--text-primary); cursor: pointer;">
                        <input type="checkbox" id="generalEssayCheckbox" style="width: 18px; height: 18px;">
                        <span>General/Common App (not school-specific)</span>
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeCollegeModal()">Cancel</button>
                <button class="btn btn-primary" onclick="startAnalysisWithColleges()">
                    <i class="fas fa-magic"></i> Analyze Essay
                </button>
            </div>
        </div>
    </div>

    <!-- AI Essay Chat Modal -->
    <div id="essayChatModal" class="modal-overlay" style="display: none;">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h2><i class="fas fa-comments"></i> Essay Coach Chat</h2>
                <button class="modal-close" onclick="closeChatModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="chatMessages" class="chat-messages">
                    <!-- Chat messages will appear here -->
                </div>
                <div class="chat-input-container">
                    <input
                        type="text"
                        id="chatInput"
                        placeholder="Ask me anything about your essay..."
                        onkeypress="if(event.key==='Enter') sendChatMessage()"
                    />
                    <button class="btn btn-primary" onclick="sendChatMessage()">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-logo">
                <img src="images/whiteclearcc.png" alt="College Climb Logo">
            </div>
            <div class="footer-text">
                &copy; 2025 College Climb. All rights reserved.
            </div>
            <div class="footer-socials">
                <a href="https://instagram.com/" target="_blank" rel="noopener" aria-label="Instagram">
                    <img src="https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/instagram.svg" alt="Instagram">
                </a>
                <a href="https://x.com/" target="_blank" rel="noopener" aria-label="X (Twitter)">
                    <img src="https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/x.svg" alt="X">
                </a>
                <a href="https://tiktok.com/" target="_blank" rel="noopener" aria-label="TikTok">
                    <img src="https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/tiktok.svg" alt="TikTok">
                </a>
                <a href="https://youtube.com/" target="_blank" rel="noopener" aria-label="YouTube">
                    <img src="https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/youtube.svg" alt="YouTube">
                </a>
            </div>
        </div>
    </footer>

    <!-- Firebase & JavaScript Integration -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.1/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.12.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, doc, setDoc, getDoc, query, where, getDocs, orderBy, serverTimestamp, updateDoc, onSnapshot, deleteDoc } from 'https://www.gstatic.com/firebasejs/10.12.1/firebase-firestore.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDqL5ZoTKp36sk8J5TxuHn_y6ji4i9h20s",
            authDomain: "collegeclimb-ai.firebaseapp.com",
            projectId: "collegeclimb-ai",
            storageBucket: "collegeclimb-ai.firebasestorage.app",
            messagingSenderId: "187139654658",
            appId: "1:187139654658:web:4a6cf4c43095f03212931b",
            measurementId: "G-E0B2RQM9XS"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Export to window for use in navbar script
        window.auth = auth;
        window.db = db;
        window.getDoc = getDoc;
        window.doc = doc;
        window.setDoc = setDoc;
        window.serverTimestamp = serverTimestamp;
        window.collection = collection;
        window.query = query;
        window.where = where;
        window.getDocs = getDocs;
        window.orderBy = orderBy;
        window.deleteDoc = deleteDoc;
        window.signOut = signOut;
        window.currentUser = null;
        window.userData = null;
        window.currentEssay = null;
        window.selectedPrompt = null;

        console.log('📝 Essay Coach initialized');

        // Common Application prompts
        const commonAppPrompts = [
            {
                id: 'ca1',
                title: 'Background & Story',
                preview: 'Some students have a background, identity, interest, or talent...',
                fullText: 'Some students have a background, identity, interest, or talent that is so meaningful they believe their application would be incomplete without it. If this sounds like you, then please share your story.',
                wordLimit: 650
            },
            {
                id: 'ca2', 
                title: 'Learning from Obstacles',
                preview: 'The lessons we take from obstacles we encounter...',
                fullText: 'The lessons we take from obstacles we encounter and setbacks we experience can be fundamental to later success. Recount a time when you faced a challenge, setback, or failure. How did it affect you, and what did you learn from the experience?',
                wordLimit: 650
            },
            {
                id: 'ca3',
                title: 'Challenging a Belief',
                preview: 'Reflect on a time when you questioned or challenged...',
                fullText: 'Reflect on a time when you questioned or challenged a belief or idea. What prompted your thinking? What was the outcome?',
                wordLimit: 650
            },
            {
                id: 'ca4',
                title: 'Gratitude',
                preview: 'Reflect on something that someone has done for you...',
                fullText: 'Reflect on something that someone has done for you that has made you happy or thankful in a surprising way. How has this gratitude affected or motivated you?',
                wordLimit: 650
            },
            {
                id: 'ca5',
                title: 'Personal Growth',
                preview: 'Discuss an accomplishment, event, or realization...',
                fullText: 'Discuss an accomplishment, event, or realization that sparked a period of personal growth and a new understanding of yourself or others.',
                wordLimit: 650
            },
            {
                id: 'ca6',
                title: 'Engaging Topic',
                preview: 'Describe a topic, idea, or concept you find so engaging...',
                fullText: 'Describe a topic, idea, or concept you find so engaging that it makes you lose all track of time. Why does it captivate you? What or who do you turn to when you want to learn more?',
                wordLimit: 650
            },
            {
                id: 'ca7',
                title: 'Free Choice',
                preview: 'Share an essay on any topic of your choice...',
                fullText: 'Share an essay on any topic of your choice. It can be one you\'ve already written, one that responds to a different prompt, or one of your own design.',
                wordLimit: 650
            }
        ];

        // School-specific prompts database
        const schoolPrompts = {
            'Harvard University': [
                'Harvard has long recognized the importance of enrolling a diverse student body. How will the life experiences that shape who you are today enable you to contribute to Harvard?',
                'Briefly describe an intellectual experience (course, project, book, discussion, paper, poetry, or research topic in engineering, mathematics, science or other modes of inquiry) that has meant the most to you.'
            ],
            'Stanford University': [
                'What is the most significant challenge that society faces today?',
                'How did you spend your most recent summer break?',
                'What historical moment or event do you wish you could have witnessed?'
            ],
            'MIT': [
                'We know you lead a busy life, full of activities, many of which are required of you. Tell us about something you do simply for the pleasure of it.',
                'Although you may not yet know what you want to major in, which department or program at MIT appeals to you and why?'
            ]
        };

        // Auth state management
        onAuthStateChanged(auth, async (user) => {
            console.log('👤 Auth state changed:', user ? `User: ${user.email}` : 'No user');
            
            if (user) {
                window.currentUser = user;
                await loadUserData(user);
                await loadNavbarUserData(user.uid);
                await initializeEssayCoach();
            } else {
                window.location.href = 'login.html';
            }
        });

        // Load user data
        async function loadUserData(user) {
            try {
                const userDoc = await getDoc(doc(db, 'users', user.uid));
                
                if (userDoc.exists()) {
                    window.userData = userDoc.data();
                    console.log('📊 User data loaded:', window.userData);
                    personalizeEssayCoach();
                } else {
                    window.userData = {
                        email: user.email,
                        name: user.displayName || user.email.split('@')[0]
                    };
                }
            } catch (error) {
                console.error('❌ Error loading user data:', error);
            }
        }

        // Initialize Essay Coach with user data
        async function initializeEssayCoach() {
            try {
                console.log('🚀 Initializing Essay Coach...');
                
                loadPersonalStatementPrompts();
                loadSupplementalPrompts();
                await loadUserEssays();
                generatePersonalizedTips();
                updateProgressTracker();
                await loadEssayDraft();
                
                console.log('✅ Essay Coach initialized');
                
            } catch (error) {
                console.error('❌ Error initializing Essay Coach:', error);
            }
        }

        // Personalize based on user data
        function personalizeEssayCoach() {
            const userData = window.userData;
            const headerMessage = document.getElementById('headerMessage');
            
            if (userData?.name) {
                const questionnaire = userData.questionnaire;
                if (questionnaire?.intendedMajor) {
                    headerMessage.textContent = `Hi ${userData.name}! Let's craft compelling essays that showcase your passion for ${questionnaire.intendedMajor} and your unique story.`;
                } else {
                    headerMessage.textContent = `Hi ${userData.name}! Let's create essays that truly represent who you are and what you'll bring to college.`;
                }
            }
        }

        // Load Personal Statement prompts
        function loadPersonalStatementPrompts() {
            const promptGrid = document.getElementById('personalPromptGrid');
            if (!promptGrid) return;
            
            promptGrid.innerHTML = '';
            
            commonAppPrompts.forEach(prompt => {
                const promptCard = document.createElement('div');
                promptCard.className = 'prompt-card';
                promptCard.onclick = () => selectPrompt(prompt);
                
                promptCard.innerHTML = `
                    <div class="prompt-title">${prompt.title}</div>
                    <div class="prompt-preview">${prompt.preview}</div>
                    <div style="margin-top: 0.5rem; font-size: 0.8rem; color: var(--accent-color);">
                        ${prompt.wordLimit} word limit
                    </div>
                `;
                
                promptGrid.appendChild(promptCard);
            });
        }

        // Load supplemental prompts based on target schools
        function loadSupplementalPrompts() {
            const supplementalContainer = document.getElementById('supplementalPrompts');
            if (!supplementalContainer) return;
            
            const targetSchools = window.userData?.questionnaire?.targetSchools || [];
            
            if (targetSchools.length === 0) {
                supplementalContainer.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                        <i class="fas fa-info-circle" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                        <p>Complete your profile to see school-specific essay prompts for your target colleges.</p>
                        <a href="profile.html" style="color: var(--accent-color); text-decoration: none;">
                            Update Profile →
                        </a>
                    </div>
                `;
                return;
            }
            
            supplementalContainer.innerHTML = '';
            targetSchools.forEach(schoolName => {
                if (schoolPrompts[schoolName]) {
                    const schoolSection = document.createElement('div');
                    schoolSection.style.marginBottom = '2rem';
                    
                    schoolSection.innerHTML = `
                        <h4 style="color: var(--accent-color); margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-university"></i> ${schoolName}
                        </h4>
                        <div class="prompt-grid">
                            ${schoolPrompts[schoolName].map((prompt, index) => `
                                <div class="prompt-card" onclick="selectSupplementalPrompt('${schoolName}', ${index})">
                                    <div class="prompt-title">Essay ${index + 1}</div>
                                    <div class="prompt-preview">${prompt.substring(0, 100)}...</div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                    
                    supplementalContainer.appendChild(schoolSection);
                }
            });
        }

        // Select prompt
        function selectPrompt(prompt) {
            document.querySelectorAll('.prompt-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            event.target.closest('.prompt-card').classList.add('selected');
            window.selectedPrompt = prompt;
            
            const textarea = document.getElementById('essayText');
            const progressTitle = document.getElementById('essayProgressTitle');
            
            if (progressTitle) {
                progressTitle.textContent = `${prompt.title} (${prompt.wordLimit} words)`;
            }
            
            if (textarea && !textarea.textContent.trim()) {
                textarea.setAttribute('data-placeholder', `Prompt: ${prompt.fullText}\n\nStart writing your response here...`);
            }
            
            updateWordCount();
        }

        // Update word count (fixed for contenteditable)
        function updateWordCount() {
            const essayDiv = document.getElementById('essayText');
            if (!essayDiv) return;
            
            const text = (essayDiv.innerText || essayDiv.textContent || '').trim();
            const words = text ? text.split(/\s+/).filter(word => word.length > 0).length : 0;
            const characters = text.length;

            const wordCountEl = document.getElementById('wordCount');
            const charCountEl = document.getElementById('charCount');
            
            if (wordCountEl) wordCountEl.textContent = words;
            if (charCountEl) charCountEl.textContent = characters;

            if (window.selectedPrompt) {
                const progress = Math.min((words / window.selectedPrompt.wordLimit) * 100, 100);
                const progressFill = document.getElementById('progressFill');
                const progressPercent = document.getElementById('essayProgressPercent');
                
                if (progressFill) progressFill.style.width = progress + '%';
                if (progressPercent) progressPercent.textContent = Math.round(progress) + '%';
            }
        }

        // Clear all highlights
        function clearHighlights() {
            const essayDiv = document.getElementById('essayText');
            if (!essayDiv) return;
            
            const highlightedElements = essayDiv.querySelectorAll('.highlight-red, .highlight-yellow, .highlight-green');
            highlightedElements.forEach(el => {
                const parent = el.parentNode;
                while (el.firstChild) {
                    parent.insertBefore(el.firstChild, el);
                }
                parent.removeChild(el);
            });

            const legend = document.getElementById('highlightLegend');
            if (legend) legend.style.display = 'none';
            
            essayDiv.normalize();
        }

        // Save progress automatically
        async function saveProgress() {
            if (!window.currentUser || !window.selectedPrompt) return;

            try {
                const essayDiv = document.getElementById('essayText');
                const content = essayDiv.innerText || essayDiv.textContent || '';

                const essayData = {
                    userId: window.currentUser.uid,
                    type: 'personal-statement',
                    promptId: window.selectedPrompt.id,
                    promptTitle: window.selectedPrompt.title,
                    content: content,
                    wordCount: parseInt(document.getElementById('wordCount')?.textContent || '0'),
                    lastUpdated: serverTimestamp(),
                    isDraft: true
                };

                await setDoc(doc(db, 'essays', `${window.currentUser.uid}_${window.selectedPrompt.id}`), essayData);
                console.log('📝 Essay progress saved');

            } catch (error) {
                console.error('❌ Error saving progress:', error);
            }
        }

        // Load essay draft
        async function loadEssayDraft() {
            if (!window.currentUser) return;
            
            try {
                const essaysQuery = query(
                    collection(db, 'essays'),
                    where('userId', '==', window.currentUser.uid),
                    where('type', '==', 'personal-statement'),
                    where('isDraft', '==', true)
                );
                
                const querySnapshot = await getDocs(essaysQuery);
                
                if (!querySnapshot.empty) {
                    const essayDoc = querySnapshot.docs[0];
                    const essayData = essayDoc.data();
                    
                    const essayDiv = document.getElementById('essayText');
                    if (essayDiv) {
                        essayDiv.textContent = essayData.content || '';
                    }
                    
                    const prompt = commonAppPrompts.find(p => p.id === essayData.promptId);
                    if (prompt) {
                        window.selectedPrompt = prompt;
                        const progressTitle = document.getElementById('essayProgressTitle');
                        if (progressTitle) {
                            progressTitle.textContent = `${prompt.title} (${prompt.wordLimit} words)`;
                        }
                        
                        setTimeout(() => {
                            const promptCards = document.querySelectorAll('.prompt-card');
                            promptCards.forEach((card, index) => {
                                if (commonAppPrompts[index].id === prompt.id) {
                                    card.classList.add('selected');
                                }
                            });
                        }, 500);
                    }
                    
                    updateWordCount();
                    console.log('📄 Loaded essay draft');
                }
                
            } catch (error) {
                console.error('❌ Error loading essay draft:', error);
            }
        }

        // Generate personalized tips
        function generatePersonalizedTips() {
            const tipsContainer = document.getElementById('personalizedTips');
            if (!tipsContainer) return;
            
            const questionnaire = window.userData?.questionnaire;
            const tips = [];
            
            if (questionnaire?.intendedMajor) {
                tips.push({
                    icon: 'fas fa-graduation-cap',
                    title: `${questionnaire.intendedMajor} Focus`,
                    content: `Since you're interested in ${questionnaire.intendedMajor}, consider including specific examples of how you've explored this field through coursework, projects, or experiences.`
                });
            }
            
            if (questionnaire?.extracurriculars?.length > 0) {
                const activities = questionnaire.extracurriculars.slice(0, 2).join(' and ');
                tips.push({
                    icon: 'fas fa-star',
                    title: 'Leverage Your Activities',
                    content: `Your involvement in ${activities} could provide excellent material for demonstrating leadership, passion, or personal growth in your essays.`
                });
            }
            
            tips.push({
                icon: 'fas fa-edit',
                title: 'Show, Don\'t Tell',
                content: 'Use specific examples and anecdotes rather than general statements. Let your experiences demonstrate your qualities.'
            });
            
            tips.push({
                icon: 'fas fa-clock',
                title: 'Start Strong',
                content: 'Your opening paragraph should grab attention. Consider starting with a scene, dialogue, or thought-provoking question.'
            });
            
            tipsContainer.innerHTML = '';
            tips.forEach(tip => {
                const tipCard = document.createElement('div');
                tipCard.className = 'tip-card';
                tipCard.innerHTML = `
                    <div class="tip-title">
                        <i class="${tip.icon}"></i> ${tip.title}
                    </div>
                    <div class="tip-content">${tip.content}</div>
                `;
                tipsContainer.appendChild(tipCard);
            });
        }

        // Load user's essays
        async function loadUserEssays() {
            if (!window.currentUser) return;
            
            try {
                const essaysQuery = query(
                    collection(db, 'essays'),
                    where('userId', '==', window.currentUser.uid),
                    orderBy('lastUpdated', 'desc')
                );
                
                const querySnapshot = await getDocs(essaysQuery);
                const essayList = document.getElementById('essayList');
                
                if (!essayList) return;
                
                if (querySnapshot.empty) {
                    essayList.innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                            <i class="fas fa-file-alt" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                            <p>No essays yet. Start writing your first essay!</p>
                        </div>
                    `;
                    return;
                }
                
                essayList.innerHTML = '';
                let completedEssays = 0;
                
                querySnapshot.forEach((doc) => {
                    const essay = doc.data();
                    if (!essay.isDraft) completedEssays++;
                    
                    const essayItem = document.createElement('div');
                    essayItem.className = 'essay-item';
                    essayItem.onclick = () => loadEssay(doc.id);
                    
                    const wordCount = essay.wordCount || '0';
                    const lastUpdated = essay.lastUpdated ? 
                        new Date(essay.lastUpdated.toDate()).toLocaleDateString() : 'Unknown';
                    
                    essayItem.innerHTML = `
                        <div class="essay-info">
                            <h4>${essay.promptTitle || 'Untitled Essay'}</h4>
                            <div class="essay-meta">
                                ${wordCount} words • Last updated: ${lastUpdated}
                                ${essay.isDraft ? ' • Draft' : ' • Complete'}
                            </div>
                        </div>
                        <div class="essay-actions">
                            <button class="essay-action-btn" onclick="event.stopPropagation(); editEssay('${doc.id}')" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="essay-action-btn" onclick="event.stopPropagation(); deleteEssay('${doc.id}')" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                    
                    essayList.appendChild(essayItem);
                });
                
                const totalCount = document.getElementById('totalEssaysCount');
                if (totalCount) totalCount.textContent = completedEssays;
                
            } catch (error) {
                console.error('❌ Error loading user essays:', error);
            }
        }

        // Update progress tracker
        function updateProgressTracker() {
            const schoolProgress = document.getElementById('schoolProgress');
            if (!schoolProgress) return;
            
            const targetSchools = window.userData?.questionnaire?.targetSchools || [];
            
            if (targetSchools.length === 0) {
                schoolProgress.innerHTML = `
                    <div style="text-align: center; color: var(--text-secondary); font-size: 0.9rem;">
                        Add target schools to track essay progress
                    </div>
                `;
                return;
            }
            
            schoolProgress.innerHTML = '';
            targetSchools.forEach(school => {
                const schoolItem = document.createElement('div');
                schoolItem.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 0; border-bottom: 1px solid var(--secondary-bg);';
                
                const progress = Math.floor(Math.random() * 100);
                const progressColor = progress >= 75 ? 'var(--success-color)' : 
                                    progress >= 50 ? 'var(--warning-color)' : 'var(--danger-color)';
                
                schoolItem.innerHTML = `
                    <div>
                        <div style="font-weight: 600; color: var(--text-primary); font-size: 0.9rem;">${school}</div>
                        <div style="font-size: 0.8rem; color: var(--text-secondary);">${progress}% complete</div>
                    </div>
                    <div style="width: 40px; height: 6px; background: var(--secondary-bg); border-radius: 3px; overflow: hidden;">
                        <div style="width: ${progress}%; height: 100%; background: ${progressColor};"></div>
                    </div>
                `;
                
                schoolProgress.appendChild(schoolItem);
            });
        }

        // Analyze essay
        async function analyzeEssay() {
            const essayDiv = document.getElementById('essayText');
            const essayText = (essayDiv.innerText || essayDiv.textContent || '').trim();

            if (!essayText) {
                alert('Please write some content before requesting analysis.');
                return;
            }

            if (essayText.split(/\s+/).length < 50) {
                alert('Please write at least 50 words for a meaningful analysis.');
                return;
            }

            clearHighlights();
            populateCollegeCheckboxes();
            document.getElementById('collegeSelectionModal').style.display = 'flex';
        }

        // Populate college checkboxes
        function populateCollegeCheckboxes() {
            const container = document.getElementById('collegeCheckboxes');
            if (!container) return;
            
            const targetSchools = window.userData?.questionnaire?.targetSchools || [];

            container.innerHTML = '';

            if (targetSchools.length === 0) {
                container.innerHTML = `
                    <div style="padding: 1rem; text-align: center; color: var(--text-secondary);">
                        <i class="fas fa-info-circle"></i>
                        <p style="margin-top: 0.5rem;">No target schools found in your profile.</p>
                        <p style="font-size: 0.9rem;">You can still get general essay advice!</p>
                    </div>
                `;
                return;
            }

            targetSchools.forEach(school => {
                const label = document.createElement('label');
                label.innerHTML = `
                    <input type="checkbox" value="${school}" class="college-checkbox">
                    <span style="color: var(--text-primary); font-weight: 500;">${school}</span>
                `;
                container.appendChild(label);
            });
        }

        // Close college modal
        window.closeCollegeModal = function() {
            document.getElementById('collegeSelectionModal').style.display = 'none';
        };

        // Start analysis with colleges
        window.startAnalysisWithColleges = async function() {
            const checkboxes = document.querySelectorAll('.college-checkbox:checked');
            const generalCheckbox = document.getElementById('generalEssayCheckbox');

            const selectedColleges = Array.from(checkboxes).map(cb => cb.value);
            const isGeneral = generalCheckbox?.checked || false;

            if (selectedColleges.length === 0 && !isGeneral) {
                alert('Please select at least one college or mark as general essay.');
                return;
            }

            closeCollegeModal();
            await performAIAnalysis(selectedColleges, isGeneral);
        };

        // Perform AI analysis
        async function performAIAnalysis(targetColleges, isGeneral) {
            const analyzeBtn = document.getElementById('analyzeBtn');
            const btnText = document.getElementById('analyzeBtnText');
            const feedbackContent = document.getElementById('feedbackContent');

            analyzeBtn.disabled = true;
            btnText.innerHTML = '<div class="loading"></div> Analyzing...';

            try {
                const essayDiv = document.getElementById('essayText');
                const essayText = (essayDiv.innerText || essayDiv.textContent || '').trim();

                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: `Analyze this essay: "${essayText}"`,
                        userProfile: {
                            name: window.userData?.name,
                            intendedMajor: window.userData?.questionnaire?.intendedMajor,
                            targetSchools: targetColleges
                        }
                    })
                });

                if (!response.ok) throw new Error('Analysis failed');

                const data = await response.json();
                displayEssayAnalysis(data.response);
                feedbackContent.classList.add('show');

            } catch (error) {
                console.error('❌ Error analyzing essay:', error);
                alert('Sorry, I had trouble analyzing your essay. Please try again.');
            } finally {
                analyzeBtn.disabled = false;
                btnText.innerHTML = '<i class="fas fa-magic"></i> Analyze My Essay';
            }
        }

        // Display analysis
        function displayEssayAnalysis(analysisText) {
            const scoreNumber = document.getElementById('scoreNumber');
            const scoreTitle = document.getElementById('scoreTitle');
            const scoreDescription = document.getElementById('scoreDescription');
            const scoreCircle = document.getElementById('scoreCircle');
            const feedbackCategories = document.getElementById('feedbackCategories');

            const score = 85;
            if (scoreNumber) scoreNumber.textContent = score;
            if (scoreCircle) scoreCircle.className = 'score-circle score-excellent';
            if (scoreTitle) scoreTitle.textContent = 'Excellent Essay!';
            if (scoreDescription) scoreDescription.textContent = 'Your essay demonstrates strong personal voice and compelling storytelling.';

            if (feedbackCategories) {
                feedbackCategories.innerHTML = `
                    <div class="feedback-category">
                        <div class="category-header">
                            <div class="category-title">
                                <i class="fas fa-robot"></i> AI Detailed Analysis
                            </div>
                        </div>
                        <div class="category-feedback">${analysisText}</div>
                    </div>
                `;
            }
        }

        // Open chat modal
        window.openChatModal = function() {
            const modal = document.getElementById('essayChatModal');
            const chatMessages = document.getElementById('chatMessages');

            if (modal) modal.style.display = 'flex';

            if (chatMessages && chatMessages.children.length === 0) {
                addChatMessage('ai', `Hi ${window.userData?.name || 'there'}! 👋 I'm here to help with your essay. Ask me anything!`);
            }
        };

        // Close chat modal
        window.closeChatModal = function() {
            const modal = document.getElementById('essayChatModal');
            if (modal) modal.style.display = 'none';
        };

        // Send chat message
        window.sendChatMessage = async function() {
            const input = document.getElementById('chatInput');
            if (!input) return;
            
            const message = input.value.trim();
            if (!message) return;

            addChatMessage('user', message);
            input.value = '';

            const typingId = addChatMessage('ai', '<div class="loading"></div> Thinking...');

            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: message,
                        userProfile: { name: window.userData?.name }
                    })
                });

                if (!response.ok) throw new Error('Chat failed');

                const data = await response.json();
                document.getElementById(typingId)?.remove();
                addChatMessage('ai', data.response);

            } catch (error) {
                console.error('❌ Error in chat:', error);
                document.getElementById(typingId)?.remove();
                addChatMessage('ai', 'Sorry, I had trouble processing that. Please try again.');
            }
        };

        // Add chat message
        function addChatMessage(sender, text) {
            const chatMessages = document.getElementById('chatMessages');
            if (!chatMessages) return '';
            
            const messageId = 'msg-' + Date.now();
            const messageDiv = document.createElement('div');
            messageDiv.id = messageId;
            messageDiv.className = `chat-message ${sender}`;

            const avatar = document.createElement('div');
            avatar.className = 'chat-avatar';
            avatar.textContent = sender === 'user' ? (window.userData?.name?.[0]?.toUpperCase() || 'U') : '🤖';

            const bubble = document.createElement('div');
            bubble.className = 'chat-bubble';
            bubble.innerHTML = text;

            messageDiv.appendChild(avatar);
            messageDiv.appendChild(bubble);
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;

            return messageId;
        }

        // Tab switching
        window.switchTab = function(tabId) {
            document.querySelectorAll('.essay-tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            
            document.querySelectorAll('.essay-content').forEach(content => content.classList.remove('active'));
            const targetContent = document.getElementById(tabId + '-content');
            if (targetContent) targetContent.classList.add('active');
        };

        // Save essay
        window.saveEssay = async function() {
            if (!window.currentUser || !window.selectedPrompt) {
                alert('Please select a prompt first.');
                return;
            }
            
            const essayDiv = document.getElementById('essayText');
            const essayText = (essayDiv.innerText || essayDiv.textContent || '').trim();

            if (!essayText) {
                alert('Please write some content before saving.');
                return;
            }

            try {
                await setDoc(doc(db, 'essays', `${window.currentUser.uid}_${window.selectedPrompt.id}_${Date.now()}`), {
                    userId: window.currentUser.uid,
                    type: 'personal-statement',
                    promptId: window.selectedPrompt.id,
                    promptTitle: window.selectedPrompt.title,
                    content: essayText,
                    wordCount: parseInt(document.getElementById('wordCount')?.textContent || '0'),
                    lastUpdated: serverTimestamp(),
                    isDraft: false
                });

                alert('✅ Essay saved successfully!');
                await loadUserEssays();
                
            } catch (error) {
                console.error('❌ Error saving essay:', error);
                alert('Failed to save essay. Please try again.');
            }
        };

        // Export essay
        window.exportEssay = function() {
            const essayDiv = document.getElementById('essayText');
            const essayText = (essayDiv.innerText || essayDiv.textContent || '').trim();

            if (!essayText) {
                alert('No content to export.');
                return;
            }

            const promptTitle = window.selectedPrompt ? window.selectedPrompt.title : 'Essay';
            const blob = new Blob([essayText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${promptTitle.replace(/[^a-z0-9]/gi, '_')}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        };

        // Clear essay
        window.clearEssay = function() {
            if (confirm('Are you sure you want to clear this essay? This action cannot be undone.')) {
                const essayDiv = document.getElementById('essayText');
                if (essayDiv) essayDiv.innerHTML = '';
                clearHighlights();
                updateWordCount();
            }
        };

        // Load essay
        window.loadEssay = async function(essayId) {
            try {
                const essayDoc = await getDoc(doc(db, 'essays', essayId));
                if (essayDoc.exists()) {
                    const essay = essayDoc.data();
                    const essayDiv = document.getElementById('essayText');
                    if (essayDiv) essayDiv.textContent = essay.content || '';
                    
                    const prompt = commonAppPrompts.find(p => p.id === essay.promptId);
                    if (prompt) {
                        window.selectedPrompt = prompt;
                        const progressTitle = document.getElementById('essayProgressTitle');
                        if (progressTitle) progressTitle.textContent = `${prompt.title} (${prompt.wordLimit} words)`;
                    }
                    
                    updateWordCount();
                    document.querySelector('.essay-tab')?.click();
                }
            } catch (error) {
                console.error('❌ Error loading essay:', error);
                alert('Failed to load essay.');
            }
        };

        // Edit and delete essay
        window.editEssay = (essayId) => window.loadEssay(essayId);
        
        window.deleteEssay = async function(essayId) {
            if (!confirm('Are you sure you want to delete this essay? This action cannot be undone.')) return;
            
            try {
                await deleteDoc(doc(db, 'essays', essayId));
                alert('Essay deleted successfully.');
                await loadUserEssays();
            } catch (error) {
                console.error('❌ Error deleting essay:', error);
                alert('Failed to delete essay.');
            }
        };

        // Expose functions
        window.selectPrompt = selectPrompt;
        window.updateWordCount = updateWordCount;
        window.saveProgress = saveProgress;
        window.analyzeEssay = analyzeEssay;
        window.clearHighlights = clearHighlights;

    </script>

    <!-- Theme and UI Enhancement Script -->
    <script>
        // ============================================
        // NAVBAR FUNCTIONALITY
        // ============================================

        let currentUserData = null;

        // Theme Management
        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.body.setAttribute('data-theme', savedTheme);
            updateThemeButton(savedTheme);
            updateLogo(savedTheme);
        }

        function updateThemeButton(theme) {
            const themeToggle = document.getElementById('ccThemeToggle');
            if (themeToggle) {
                themeToggle.textContent = theme === 'dark' ? '☀️' : '🌙';
            }
        }

        function updateLogo(theme) {
            const logo = document.getElementById('ccNavbarLogo');
            if (logo) {
                logo.src = theme === 'dark' ? 'images/whiteclearcc.png' : 'images/blackcc.png';
            }
        }

        function toggleTheme() {
            const currentTheme = document.body.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.body.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeButton(newTheme);
            updateLogo(newTheme);
        }

        // Dropdown Management
        function toggleDropdown() {
            const dropdown = document.getElementById('ccDropdownMenu');
            const container = document.getElementById('ccProfileDropdown');
            
            if (dropdown && container) {
                const isOpen = dropdown.classList.contains('show');
                if (isOpen) {
                    closeDropdown();
                } else {
                    openDropdown();
                }
            }
        }

        function openDropdown() {
            const dropdown = document.getElementById('ccDropdownMenu');
            const container = document.getElementById('ccProfileDropdown');
            
            if (dropdown && container) {
                dropdown.classList.add('show');
                container.classList.add('open');
            }
        }

        function closeDropdown() {
            const dropdown = document.getElementById('ccDropdownMenu');
            const container = document.getElementById('ccProfileDropdown');
            
            if (dropdown && container) {
                dropdown.classList.remove('show');
                container.classList.remove('open');
            }
        }

        // Load User Data from Firestore
        async function loadNavbarUserData(userId) {
            try {
                const userDoc = await getDoc(doc(db, 'users', userId));
                
                if (userDoc.exists()) {
                    currentUserData = userDoc.data();
                    updateNavbarUI(auth.currentUser);
                } else {
                    currentUserData = {
                        email: auth.currentUser.email,
                        name: auth.currentUser.displayName || ''
                    };
                    updateNavbarUI(auth.currentUser);
                }
            } catch (error) {
                console.error('Error loading navbar user data:', error);
                currentUserData = {
                    email: auth.currentUser.email,
                    name: auth.currentUser.displayName || ''
                };
                updateNavbarUI(auth.currentUser);
            }
        }

        // Update Navbar UI with User Info
        function updateNavbarUI(user) {
            const profileLoading = document.getElementById('ccProfileLoading');
            const profileContent = document.getElementById('ccProfileContent');
            const userAvatar = document.getElementById('ccUserAvatar');
            const dropdownName = document.getElementById('ccDropdownName');
            const dropdownEmail = document.getElementById('ccDropdownEmail');

            if (!user) {
                // Not logged in - redirect to login
                if (!window.location.pathname.includes('login.html') && 
                    !window.location.pathname.includes('signup.html') &&
                    !window.location.pathname.includes('index.html') &&
                    !window.location.pathname.includes('about.html') &&
                    !window.location.pathname.includes('pricing.html')) {
                    window.location.href = 'login.html';
                }
                return;
            }

            // Hide loading, show content
            if (profileLoading) profileLoading.style.display = 'none';
            if (profileContent) profileContent.style.display = 'flex';

            // Update profile photo
            if (userAvatar && currentUserData?.profilePhotoURL) {
                userAvatar.src = currentUserData.profilePhotoURL;
            } else if (userAvatar) {
                userAvatar.src = 'images/default-avatar.png';
            }

            // Update display name
            const displayName = currentUserData?.name || user.displayName || user.email.split('@')[0];
            if (dropdownName) dropdownName.textContent = displayName;

            // Update email
            if (dropdownEmail) dropdownEmail.textContent = user.email;
        }

        // Logout Function
        async function handleLogout(e) {
            e.preventDefault();
            closeDropdown();
            
            try {
                await signOut(auth);
                window.location.href = 'login.html';
            } catch (error) {
                console.error('Error signing out:', error);
                alert('Error signing out. Please try again.');
            }
        }

        // Event Listeners
        function initEventListeners() {
            // Theme toggle
            const themeToggle = document.getElementById('ccThemeToggle');
            if (themeToggle) {
                themeToggle.addEventListener('click', toggleTheme);
            }

            // Profile button click
            const profileButton = document.getElementById('ccProfileButton');
            if (profileButton) {
                profileButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleDropdown();
                });
            }

            // Logout button
            const logoutBtn = document.getElementById('ccLogoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', handleLogout);
            }

            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                const dropdown = document.getElementById('ccProfileDropdown');
                if (dropdown && !dropdown.contains(e.target)) {
                    closeDropdown();
                }
            });

            // Close dropdown on escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    closeDropdown();
                }
            });
        }

        // Initialize Navbar
        function initNavbar() {
            console.log('🎯 Initializing College Climb Navbar...');
            
            // Initialize theme
            initTheme();
            
            // Set up event listeners
            initEventListeners();
            
            console.log('✅ Navbar initialized successfully!');
        }

        // Export for global access
        window.CollegeClimbNavbar = {
            toggleTheme,
            openDropdown,
            closeDropdown,
            refresh: () => {
                if (auth.currentUser) {
                    loadNavbarUserData(auth.currentUser.uid);
                }
            }
        };

        // Create starry background
        function createStarryBackground() {
            const starryBg = document.getElementById('starryBg');
            if (!starryBg) return;
            
            const numStars = 200;
            
            for (let i = 0; i < numStars; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                star.style.width = Math.random() * 3 + 1 + 'px';
                star.style.height = star.style.width;
                star.style.animationDelay = Math.random() * 3 + 's';
                star.style.animationDuration = (Math.random() * 2 + 2) + 's';
                starryBg.appendChild(star);
            }
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl+S to save
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                if (typeof window.saveEssay === 'function') {
                    window.saveEssay();
                }
            }
            
            // Ctrl+Shift+A to analyze
            if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'A') {
                e.preventDefault();
                if (typeof window.analyzeEssay === 'function') {
                    window.analyzeEssay();
                }
            }
        });

        // Enhanced error handling
        window.addEventListener('error', function(e) {
            console.error('Essay Coach Error:', e.error);
        });

        window.addEventListener('unhandledrejection', function(event) {
            console.error('Unhandled promise rejection:', event.reason);
        });

        // Performance monitoring
        window.addEventListener('load', function() {
            const loadTime = performance.now();
            console.log(`📝 Essay Coach loaded in ${Math.round(loadTime)}ms`);
        });

        // Initialize navbar and starry background on load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                initNavbar();
                createStarryBackground();
            });
        } else {
            initNavbar();
            createStarryBackground();
        }

    </script>
</body>
</html>